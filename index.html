<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecionando...</title>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; text-align: center; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #38bdf8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        
        // Insira os IDs dos seus pixels aqui. Você pode iniciar múltiplos pixels.
        // fbq('init', 'SEU_PIXEL_ID_1');
        
        fbq('track', 'PageView');
        fbq('track', 'ViewContent');
    </script>
    </head>
<body>
    <div>
        <div class="loader"></div>
        <p>Aguarde um instante, estamos preparando tudo para você...</p>
    </div>

    <script>
        // Configuração do redirecionamento
        const config = {
            API_BASE_URL: 'https://novaapi-one.vercel.app',
            sellerApiKey: '1a2c5da4-04fb-4eb4-b2d4-55f541360d4f',
            presselId: 15,
            whitePageUrl: 'https://br.pinterest.com/pin/22095854406665522/',
            botLink: 'https://t.me/Isadoratbot?start='
        };

        // Função principal de rastreamento e redirecionamento
        async function registerClickAndRedirect() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const bodyPayload = {
                    sellerApiKey: config.sellerApiKey,
                    presselId: config.presselId,
                    referer: document.referrer,
                    user_agent: navigator.userAgent,
                    fbclid: urlParams.get('fbclid'),
                    fbp: document.cookie.split('; ').find(row => row.startsWith('_fbp='))?.split('=')[1],
                    fbc: document.cookie.split('; ').find(row => row.startsWith('_fbc='))?.split('=')[1],
                    utm_source: urlParams.get('utm_source'),
                    utm_campaign: urlParams.get('utm_campaign'),
                    utm_medium: urlParams.get('utm_medium'),
                    utm_content: urlParams.get('utm_content'),
                    utm_term: urlParams.get('utm_term')
                };

                // Limpa chaves nulas ou indefinidas do payload
                Object.keys(bodyPayload).forEach(key => {
                    if (bodyPayload[key] === null || bodyPayload[key] === undefined) {
                        delete bodyPayload[key];
                    }
                });

                // Envia os dados de rastreamento para a API
                const response = await fetch(config.API_BASE_URL + '/api/registerClick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bodyPayload)
                });

                if (!response.ok) {
                    throw new Error('Falha ao registrar o clique. Redirecionando para a página de segurança.');
                }

                const data = await response.json();

                // Redireciona para o bot com o ID do clique
                window.location.href = config.botLink + data.click_id;

            } catch (error) {
                console.error('Erro no processo de redirecionamento:', error);
                // Em caso de qualquer erro, redireciona para a página branca (fallback)
                window.location.href = config.whitePageUrl;
            }
        }

        // Inicia o processo
        registerClickAndRedirect();
    </script>
</body>
</html>
